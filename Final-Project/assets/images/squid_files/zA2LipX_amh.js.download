;/*FB_PKG_DELIM*/

__d("LSDeleteBackupOnClientStoredProcedure",["LSDeleteBackupOnClient","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSDeleteBackupOnClient"),e.backupId,e.traceContext,e.clearBackupsTable,e.traceId,e.errorMsg,e.isFlowSuccess);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSStoreAuthoritativeClientState",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][storeAuthoritativeClientState] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[14]=new c.Map(),d[14].set("error_msg","Expected a nonempty query result"),d[14].set("code",c.i64.cast([0,3])),d[14].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[15]=c.createArray(),d[16]=(d[15].push(d[14]),d[15]),e=[void 0,d[15]],d[2]=e[0],d[3]=e[1],e):(b=a.item,d[14]=new c.Map(),d[14].set("backup_id",b.backupId),d[14].set("device_public_key_blob",b.devicePublicKeyBlob),d[14].set("device_private_key_blob",b.devicePrivateKeyBlob),d[14].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[14].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[14].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[14].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[14].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[14].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[14].set("orf_client_state_v2_blob",void 0),d[14].set("orf_v2_authority_level",void 0),d[14].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[14].set("device_id",b.deviceId),d[14].set("backup_tenancy",b.backupTenancy),d[14].set("encryption_version",b.encryptionVersion),d[14].set("revision_version",b.revisionVersion),d[14].set("initialize_restore_result",void 0),d[14].set("authority_level",b.authorityLevel),e=[d[14],void 0],d[2]=e[0],d[3]=e[1],e)})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[14]=d[6].get("backup_id"),d[15]=d[6].get("device_public_key_blob"),d[16]=d[6].get("device_private_key_blob"),d[17]=d[6].get("epoch_storage_public_key_blob"),d[18]=d[6].get("epoch_storage_private_key_blob"),d[19]=d[6].get("epoch_auth_public_key_blob"),d[20]=d[6].get("epoch_auth_private_key_blob"),d[21]=d[6].get("mailbox_root_key_blob"),d[22]=d[6].get("ocmf_client_state_blob"),d[23]=d[6].get("orf_client_state_v2_blob"),d[24]=d[6].get("orf_v2_authority_level"),d[25]=d[6].get("oblivious_validation_token_blob"),d[26]=d[6].get("device_id"),d[27]=d[6].get("backup_tenancy"),d[28]=d[6].get("encryption_version"),d[29]=d[6].get("revision_version"),d[30]=d[6].get("initialize_restore_result"),d[31]=d[6].get("authority_level"),c.i64.neq(d[26],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[41]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[51]=(d[41].push(c.i64.cast([0,0])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[51]=(d[41].push(c.i64.cast([0,2])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[51]=(d[41].push(c.i64.cast([0,3])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[51]=(d[41].push(c.i64.cast([0,4])),d[41]):0,d[46]=c.createArray(),d[47]=c.i64.of_int32(d[41].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[46].push(d[52]),d[46])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[51].push(c.i64.to_string(d[55])),d[51])}])}):c.resolve()},function(a){return d[53]=d[51].join(","),d[48]=d[53]}])},function(a){return d[46].some(function(a){return c.i64.eq(d[28],a)})?d[49]=d[28]:d[49]=void 0,c.i64.neq(d[49],void 0)?d[50]=d[49]:d[50]=void 0,d[34]=d[50]}])},function(e){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[27],void 0)?d[36]=d[27]:d[36]=c.i64.cast([0,1]),d[37]=a[2].get("device_key"),d[38]=d[37].get("device_public_key"),c.filter(c.db.table(168).fetch([[[a[0]]]]),function(b){return c.i64.eq(b.backupId,a[0])&&c.blobs.eq(b.devicePublicKeyBlob,d[38])}).next().then(function(e,f){f=e.done;e=e.value;return f?c.sequence([function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])})},function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure] No matching row in backup client state found"),d[42]="No matching row in backup client state found",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure] ","",d[42]].join("")),d[41]=c.createArray(),void 0!==void 0?d[44]=(d[41].push(void 0),d[41]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure",d[42],d[41],c.i64.cast([0,3]))},function(a){return d[43]=new c.Map(),d[43].set("error_code",c.i64.cast([0,19])),d[43].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[43].set("error_message",""),d[39]=d[43]}]):(e.item,c.sequence([function(b){return c.forEach(c.db.table(168).fetch([[[a[0]]]]),function(b){var d=b.update;b.item;return d({deviceId:a[1],authorityLevel:c.i64.cast([0,80])})})},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,2])})},function(b){return c.forEach(c.db.table(169).fetch([[[a[0]]],"fk_secure_encrypted_backups_client_state"]),function(a){var b=a.update;a.item;return b({authorityLevel:c.i64.cast([0,80])})})},function(a){return d[39]=void 0}]))})},function(a){return d[32]=d[39]}]):c.resolve((d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,24])),d[33].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[33].set("error_message",""),d[32]=d[33]))},function(a){return d[7]=d[32]}]):c.resolve((d[14]=d[5].get("errors"),d[15]=d[5].get("errors"),d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,1])),d[16].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[16].set("error_message",""),d[7]=d[16]))},function(a){return d[8]=c.i64.of_float(Date.now()),d[9]=c.i64.random(),d[11]="Finishing execution. Execution time: ",d[12]=c.i64.to_string(c.i64.sub(d[8],d[0])),d[13]=" ms",d[10]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][storeAuthoritativeClientState] ",d[10],d[11],d[10],d[12],d[10],d[13]].join("")),c.i64.eq(c.i64.mod_(d[9],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[14]=",",d[15]=c.createArray(),void 0!==void 0?d[16]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"storeAuthoritativeClientState",[d[11],d[14],d[12],d[14],d[13]].join(""),d[15],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[7]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSStoreAuthoritativeClientStateStoredProcedure",["LSStoreAuthoritativeClientState","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSStoreAuthoritativeClientState"),e.backupId,e.deviceId,e.localKeys);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWChatEncryptedBackupsDeleteBackupsOnClientNOP",["LSDeleteBackupOnClientStoredProcedure","LSFactory","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][auto-restore] Error when deleting backups on client after device setup registration failed: ",""]);i=function(){return a};return a}function a(a,e){c("LSDeleteBackupOnClientStoredProcedure")(c("LSFactory")(e),{backupId:a,clearBackupsTable:!0,isFlowSuccess:!1})["catch"](function(a){d("WALogger").ERROR(i(),a)});return(h||(h=b("Promise"))).resolve()}g["default"]=a}),98);
__d("MWChatEncryptedBackupsStoreAuthoritativeClientStateNOP",["I64","LSFactory","LSShape","LSStoreAuthoritativeClientStateStoredProcedure","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][auto-restore] Error when storing client state after add device was successful: ",""]);i=function(){return a};return a}function a(a,b,e,f){return c("LSStoreAuthoritativeClientStateStoredProcedure")(c("LSFactory")(f),{backupId:a,deviceId:b,localKeys:e}).then(function(a){return a[0]!=null?[a[0]]:[void 0]})["catch"](function(a){d("WALogger").ERROR(i(),a);return[d("LSShape").ofRecord({error_code:(h||(h=d("I64"))).neg_one,error_message:"Error when storing client state, likely caused by database corruption",stored_procedure:"LSStoreAuthoritativeClientState"})]})}g["default"]=a}),98);