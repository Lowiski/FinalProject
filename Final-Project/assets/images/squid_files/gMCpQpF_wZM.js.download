;/*FB_PKG_DELIM*/

__d("MAWFetchAndPersistMedia",["CurrentUser","EBAPI","EchoMessage","EchoMessageMediaFieldUtils","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaRestoreEBRange","MAWMsgType","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","Promise","ReQL","WAJids","WALogger","WAResultOrError","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaPersist Protobuf error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaPersist Echo error: ",""]);m=function(){return a};return a}e=c("justknobx")._("3177");var n=c("justknobx")._("2538"),o=c("justknobx")._("3916"),p="timeout",q=e;function a(a,c,e,f){var g=d("MAWMediaRestoreEBRange").getMediaRestoreEBRange(),i=g.getRange(c),j=d("WAJids").threadIdForChatJid(a);if(i.hasMoreBefore===!1)return(k||(k=b("Promise"))).resolve();f==null?void 0:f.addPoint("eb_fetch_and_persist_start",{"int":{mediaGalleryGroup:e}});return w({jid:a,nextTimestampMsBefore:i.nextTimestampMsBefore,numMessages:q,threadId:j}).then(function(a){var b=a.error;b!=null&&(f==null?void 0:f.addPoint("eb_fetch_and_persist_error",{string:{error:b}}));if(b!==p){g.updateRange(c,{hasMoreBefore:(b=a==null?void 0:a.hasMoreBefore)!=null?b:!1,nextTimestampMsBefore:(h||(h=d("I64"))).to_string((b=a==null?void 0:a.nextMessageTimestampMsBefore)!=null?b:(h||(h=d("I64"))).zero)})}return r(a,j).then(function(){f==null?void 0:f.addPoint("eb_fetch_and_persist_end");return u(c,e,{hasMoreBefore:!0})})})}function r(a,c){if(a.success===!1)return(k||(k=b("Promise"))).resolve();if(a.echoMessages!=null)return s(a,c);return a.protobufMessages!=null?t(a,c):(k||(k=b("Promise"))).resolve()}function s(a,b){var e;e=(e=a==null?void 0:a.echoMessages)!=null?e:[];var f=[d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE,d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO],g=e.filter(function(a){a=d("EchoMessage").decodeEchoMessage(a);return(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA&&f.includes(a==null?void 0:(a=a.mediaData)==null?void 0:a.attachmentType)});e.length!==g.length&&(q=n);return d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(b),g,(e=a==null?void 0:a.hasMoreBefore)!=null?e:!1,void 0,(b=a==null?void 0:a.hasMoreAfter)!=null?b:!1,void 0,(g=a==null?void 0:a.isPointQuery)!=null?g:!1,a==null?void 0:a.requestId,a==null?void 0:a.referenceTimestamp,c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)["catch"](function(a){d("WALogger").ERROR(m(),a)})}function t(a,b){var e,f=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());e=(e=a==null?void 0:a.protobufMessages)!=null?e:[];var g=[d("MAWMsgType").MSG_TYPE.IMAGE,d("MAWMsgType").MSG_TYPE.VIDEO],i=e.filter(function(a){a=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(a,f,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);return g.includes(a.msgType)});e.length!==i.length&&(q=n);return d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(b),i,(e=a==null?void 0:a.hasMoreBefore)!=null?e:!1,void 0,(b=a==null?void 0:a.hasMoreAfter)!=null?b:!1,void 0,(i=a==null?void 0:a.isPointQuery)!=null?i:!1,a==null?void 0:a.requestId,a==null?void 0:a.referenceTimestamp,void 0,void 0,(h||(h=d("I64"))).of_int32(c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE))["catch"](function(a){d("WALogger").ERROR(l(),a)})}function u(a,b,c){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var g=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);return g.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(g.tables.attachments_ranges_v2__generated).getKeyRange(a).filter(function(a){return(h||(h=d("I64"))).equal(a.mediaGroup,(j||(j=d("LSIntEnum"))).ofNumber(c))})));if(f==null)return;var i=babelHelpers["extends"]({},f,e);return b.attachments_ranges_v2__generated.upsert([f.threadKey,f.mediaGroup,f.minTimestampMs],i)});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":218")});return v.apply(this,arguments)}function w(a){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e,f=a.jid,g=a.nextTimestampMsBefore,i=a.numMessages;a=a.threadId;g=c("EBAPI").messageRangeQueryForIndexing({chatJid:f,direction:"before",numMessages:i,sortOrderMs:g,source:c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,traceId:"mediaGallery"});var j=null;g=(yield (k||(k=b("Promise"))).race([g,new k(function(a){j=window.setTimeout(function(){return a(d("WAResultOrError").makeError(p))},o)})]));window.clearTimeout(j);if(g.success===!1)return g;g=g.value;e=(h||(h=d("I64"))).to_string((e=g==null?void 0:g.nextMessageTimestampMsBefore)!=null?e:(h||(h=d("I64"))).zero);return(g==null?void 0:g.referenceTimestamp)===e?i===n?d("WAResultOrError").makeError("Retried with max pageSize: "+n+". Still stuck"):w({jid:f,nextTimestampMsBefore:e,numMessages:n,threadId:a}):g});return x.apply(this,arguments)}g.MAWFetchAndPersistMedia=a;g.updateLocalAttachmentsRange=u}),98);