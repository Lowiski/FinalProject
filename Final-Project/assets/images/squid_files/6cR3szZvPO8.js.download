;/*FB_PKG_DELIM*/

__d("LSDeriveOnboardingMaterial",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSDeriveAndStoreEpochs","LSGetBlobFromString.nop","LSGetLatestEpochKeys","LSHmac_v2.nop","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][deriveOnboardingMaterial] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSDeriveAndStoreEpochs"),a[3],void 0,c.i64.cast([0,9]),void 0)},function(a){return c.storedProcedure(b("LSGetLatestEpochKeys"),!1).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(e){return d[2]!==void 0?c.sequence([function(a){return d[12]=d[2].get("epoch_keys"),d[13]=d[12].get("epoch_anon_id"),d[14]=d[12].get("epoch_root_key"),d[15]=c.createArray(),d[21]=(d[15].push(c.i64.cast([0,32])),d[15]),c.nativeOperation(b("LSBase64Encode.nop"),d[13]).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[16]].join("")),void 0,d[14],d[15]).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!1:d[22]=!0,d[22]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[25]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[25]].join("")),d[24]=c.createArray(),void 0!==void 0?d[27]=(d[24].push(void 0),d[24]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[25],d[24],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[23]=d[26]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],c.i64.cast([0,0])).then(function(a){return a=a,d[24]=a[0],d[25]=a[1],a})},function(a){return d[23]=d[24]}])},function(a){return d[17]=d[23]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[22]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[22]].join("")),d[21]=c.createArray(),void 0!==void 0?d[24]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[22],d[21],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[17]=d[23]}])},function(e){return c.nativeOperation(b("LSHmac_v2.nop"),d[17],a[0]).then(function(a){return a=a,d[18]=a[0],a})},function(e){return c.blobs.neq(d[18],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),a[2]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(a){return c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return a=[d[21],d[22],d[28],d[29]],d[23]=a[0],d[24]=a[1],d[25]=a[2],d[26]=a[3],a}]):c.resolve((a=[d[21],d[22],void 0,void 0],d[23]=a[0],d[24]=a[1],d[25]=a[2],d[26]=a[3],a))},function(a){return d[27]=new c.Map(),d[27].set("epoch_keys",d[12]),d[27].set("new_ocmf_client_state",d[23]),d[27].set("ocmf_rotation_token",d[24]),d[27].set("device_epoch_hmac",d[18]),a=[d[27],void 0],d[19]=a[0],d[20]=a[1],a}]):c.resolve((d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,605])),d[21].set("stored_procedure","LSEncryptedBackupsDeriveOnboardingMaterialStoredProcedure"),d[21].set("error_message",""),e=[void 0,d[21]],d[19]=e[0],d[20]=e[1],e))},function(a){return a=[d[19],d[20]],d[4]=a[0],d[5]=a[1],a}]):c.resolve((e=[void 0,d[3]],d[4]=e[0],d[5]=e[1],e))},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][deriveOnboardingMaterial] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"deriveOnboardingMaterial",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[4],d[5]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDeriveOnboardingMaterialStoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSOnboardFromExistingDeviceRegister",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSDeriveOnboardingMaterial","LSGenerateLocalKeys","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][onboardFromExistingDeviceRegister] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[14]=new c.Map(),d[14].set("error_msg","Expected a nonempty query result"),d[14].set("code",c.i64.cast([0,3])),d[14].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[15]=c.createArray(),d[16]=(d[15].push(d[14]),d[15]),e=[void 0,d[15]],d[2]=e[0],d[3]=e[1],e):(b=a.item,d[14]=new c.Map(),d[14].set("backup_id",b.backupId),d[14].set("device_public_key_blob",b.devicePublicKeyBlob),d[14].set("device_private_key_blob",b.devicePrivateKeyBlob),d[14].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[14].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[14].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[14].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[14].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[14].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[14].set("orf_client_state_v2_blob",void 0),d[14].set("orf_v2_authority_level",void 0),d[14].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[14].set("device_id",b.deviceId),d[14].set("backup_tenancy",b.backupTenancy),d[14].set("encryption_version",b.encryptionVersion),d[14].set("revision_version",b.revisionVersion),d[14].set("initialize_restore_result",void 0),d[14].set("authority_level",b.authorityLevel),e=[d[14],void 0],d[2]=e[0],d[3]=e[1],e)})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[14]=d[6].get("backup_id"),d[15]=d[6].get("device_public_key_blob"),d[16]=d[6].get("device_private_key_blob"),d[17]=d[6].get("epoch_storage_public_key_blob"),d[18]=d[6].get("epoch_storage_private_key_blob"),d[19]=d[6].get("epoch_auth_public_key_blob"),d[20]=d[6].get("epoch_auth_private_key_blob"),d[21]=d[6].get("mailbox_root_key_blob"),d[22]=d[6].get("ocmf_client_state_blob"),d[23]=d[6].get("orf_client_state_v2_blob"),d[24]=d[6].get("orf_v2_authority_level"),d[25]=d[6].get("oblivious_validation_token_blob"),d[26]=d[6].get("device_id"),d[27]=d[6].get("backup_tenancy"),d[28]=d[6].get("encryption_version"),d[29]=d[6].get("revision_version"),d[30]=d[6].get("initialize_restore_result"),d[31]=d[6].get("authority_level"),c.i64.neq(d[26],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[39]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[40]=a[0],a})},function(a){return d[40]?d[49]=(d[39].push(c.i64.cast([0,0])),d[39]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[41]=a[0],a})},function(a){return d[41]?d[49]=(d[39].push(c.i64.cast([0,2])),d[39]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[49]=(d[39].push(c.i64.cast([0,3])),d[39]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[49]=(d[39].push(c.i64.cast([0,4])),d[39]):0,d[44]=c.createArray(),d[45]=c.i64.of_int32(d[39].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(a){return d[49]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[39],d[49]).then(function(a){return a=a,d[50]=a[0],d[51]=a[1],a})},function(a){return d[52]=(d[44].push(d[50]),d[44])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[49]=c.createArray(),d[50]=c.i64.of_int32(d[44].length),c.i64.gt(d[50],c.i64.cast([0,0]))?c.loopAsync(d[50],function(a){return d[52]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[44],d[52]).then(function(a){return a=a,d[53]=a[0],d[54]=a[1],a})},function(a){return d[55]=(d[49].push(c.i64.to_string(d[53])),d[49])}])}):c.resolve()},function(a){return d[51]=d[49].join(","),d[46]=d[51]}])},function(a){return d[44].some(function(a){return c.i64.eq(d[28],a)})?d[47]=d[28]:d[47]=void 0,c.i64.neq(d[47],void 0)?d[48]=d[47]:d[48]=void 0,d[34]=d[48]}])},function(e){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[27],void 0)?d[36]=d[27]:d[36]=c.i64.cast([0,1]),c.db.table(185).fetch([[[c.i64.cast([0,1])]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,18])),d[39].set("stored_procedure","onboardFromExistingDeviceRegister"),d[39].set("error_message","Device metadata fetch error"),d[40]=new c.Map(),d[40].set("failure",d[39]),d[41]=c.toJSON(d[40]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[41],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[43]=new c.Map(),d[43].set("error_code",c.i64.cast([0,18])),d[43].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[43].set("error_message",""),d[37]=d[43]}]):(f=e.item,c.sequence([function(a){return c.storedProcedure(b("LSGenerateLocalKeys"),!1).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(e){return d[39]!==void 0?c.sequence([function(e){return d[42]=d[39].get("device_key"),d[43]=d[39].get("epoch_storage_key"),d[44]=d[39].get("epoch_auth_key"),d[45]=d[42].get("device_public_key"),c.storedProcedure(b("LSDeriveOnboardingMaterial"),d[45],d[43],d[22],a[1]).then(function(a){return a=a,d[46]=a[0],d[47]=a[1],a})},function(e){return d[46]!==void 0?c.sequence([function(a){return d[49]=d[46].get("epoch_keys"),d[50]=d[46].get("new_ocmf_client_state"),d[51]=d[42].get("device_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[53]=d[46].get("device_epoch_hmac"),c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[55]=d[46].get("epoch_keys"),d[56]=d[55].get("epoch_root_key"),c.blobs.neq(d[56],void 0)?c.sequence([function(a){return d[107]=c.createArray(),d[113]=(d[107].push(c.i64.cast([0,18])),d[107]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[56],d[107]).then(function(a){return a=a,d[108]=a[0],a})},function(a){return d[108]!==void 0?c.sequence([function(a){return d[113]=c.i64.of_int32(d[108].length),c.i64.ge(d[113],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[108],c.i64.cast([0,0])).then(function(a){return a=a,d[115]=a[0],d[116]=a[1],a})},function(a){return d[114]=d[115]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[116]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[116]].join("")),d[115]=c.createArray(),void 0!==void 0?d[117]=(d[115].push(void 0),d[115]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[116],d[115],c.i64.cast([0,3]))},function(a){return d[114]=void 0}])},function(a){return d[109]=d[114]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[114]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[114]].join("")),d[113]=c.createArray(),void 0!==void 0?d[115]=(d[113].push(void 0),d[113]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[114],d[113],c.i64.cast([0,3]))},function(a){return d[109]=void 0}])},function(a){return c.blobs.neq(d[109],void 0)?d[110]=!0:d[110]=!1,d[110]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSBase64Encode.nop"),d[109]).then(function(a){return a=a,d[111]=a[0],a})},function(a){return d[111]!==void 0?d[112]=d[111]:d[112]="encodingfailed",d[57]=d[112]}]):c.resolve(d[57]="null")},function(a){return d[58]=d[43].get("epoch_storage_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[58]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return d[60]=d[39].get("epoch_storage_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[62]=d[44].get("epoch_auth_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[62]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return d[64]=d[39].get("epoch_auth_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[64]).then(function(a){return a=a,d[65]=a[0],a})},function(a){return d[66]=d[46].get("ocmf_rotation_token"),c.nativeOperation(b("LSBase64Encode.nop"),d[66]).then(function(a){return a=a,d[67]=a[0],a})},function(a){return d[68]=d[42].get("device_private_key"),d[69]=d[43].get("epoch_storage_private_key"),c.blobs.neq(d[21],void 0)?c.sequence([function(a){return d[107]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[21],"private_key",d[68],c.i64.cast([0,1]),d[107]).then(function(a){return a=a,d[108]=a[0],a})},function(a){return c.blobs.neq(d[108],void 0)?d[109]=d[108]:d[109]=void 0,d[70]=d[109]}]):c.resolve(d[70]=void 0)},function(a){return c.blobs.neq(d[70],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[70]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[71]=d[107]}]):c.resolve(d[71]=void 0)},function(a){return c.blobs.neq(d[21],void 0)?c.sequence([function(a){return d[107]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[21],"ocmf_client_state",d[50],c.i64.cast([0,1]),d[107]).then(function(a){return a=a,d[108]=a[0],a})},function(a){return c.blobs.neq(d[108],void 0)?d[109]=d[108]:d[109]=void 0,d[72]=d[109]}]):c.resolve(d[72]=void 0)},function(a){return c.blobs.neq(d[72],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[72]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[73]=d[107]}]):c.resolve(d[73]=void 0)},function(a){return c.blobs.neq(d[21],void 0)?c.sequence([function(a){return d[107]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[21],"epoch_storage_private_key",d[69],c.i64.cast([0,1]),d[107]).then(function(a){return a=a,d[108]=a[0],a})},function(a){return c.blobs.neq(d[108],void 0)?d[109]=d[108]:d[109]=void 0,d[74]=d[109]}]):c.resolve(d[74]=void 0)},function(a){return c.blobs.neq(d[74],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[74]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[75]=d[107]}]):c.resolve(d[75]=void 0)},function(a){return c.db.table(168).fetch().next().then(function(d,e){var a=d.done;d=d.value;return a?0:(e=d.item,c.storedProcedure(b("LSDeleteBackupOnClient"),e.backupId,void 0,!1,void 0,"null",!0))})},function(a){return d[76]=d[42].get("device_public_key"),d[77]=d[42].get("device_private_key"),d[78]=d[43].get("epoch_storage_public_key"),d[79]=d[43].get("epoch_storage_private_key"),d[80]=d[44].get("epoch_auth_public_key"),d[81]=d[44].get("epoch_auth_private_key"),c.forEach(c.filter(c.db.table(168).fetch([[[d[14]]]]),function(a){return c.i64.eq(a.backupId,d[14])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(b){return c.db.table(168).add({backupId:d[14],deviceId:a[0],devicePublicKeyBlob:d[76],devicePrivateKeyBlob:d[77],epochStoragePublicKeyBlob:d[78],epochStoragePrivateKeyBlob:d[79],epochAuthPublicKeyBlob:d[80],epochAuthPrivateKeyBlob:d[81],mailboxRootKeyBlob:d[21],ocmfClientStateBlob:d[50],obliviousValidationTokenBlob:d[25],authorityLevel:c.i64.cast([0,20]),backupTenancy:c.i64.cast([0,1])})},function(a){return d[82]=d[49].get("epoch_id"),d[83]=d[49].get("epoch_anon_id"),d[84]=d[49].get("epoch_root_key"),c.forEach(c.filter(c.db.table(169).fetch([[[d[82]]]]),function(a){return c.i64.eq(a.epochId,d[82])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(169).add({epochId:d[82],authorityLevel:c.i64.cast([0,20]),backupId:d[14],epochAnonIdBlob:d[83],epochRootKeyBlob:d[84],epochStatus:c.i64.cast([0,1])})},function(a){return d[85]=d[42].get("device_private_key"),d[86]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[87]=a[0],a})},function(a){return d[87]?d[107]=(d[86].push(c.i64.cast([0,0])),d[86]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[88]=a[0],a})},function(a){return d[88]?d[107]=(d[86].push(c.i64.cast([0,2])),d[86]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[89]=a[0],a})},function(a){return d[89]?d[107]=(d[86].push(c.i64.cast([0,3])),d[86]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[90]=a[0],a})},function(a){return d[90]?d[107]=(d[86].push(c.i64.cast([0,4])),d[86]):0,d[91]="",d[92]=c.i64.of_int32(d[86].length),c.i64.gt(d[92],c.i64.cast([0,0]))?c.loopAsync(d[92],function(a){return d[107]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[86],d[107]).then(function(a){return a=a,d[108]=a[0],d[109]=a[1],a})},function(a){return d[91]=[d[91],"_",c.i64.to_string(d[108])].join("")}])}):c.resolve()},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",d[91],"revision_version_",c.i64.to_string(c.i64.cast([0,1]))].join("")).then(function(a){return a=a,d[93]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[85],c.blob("Mg=="),d[93]).then(function(a){return a=a,d[94]=a[0],a})},function(a){return c.blobs.neq(d[94],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[94]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[95]=d[107]}]):c.resolve(d[95]=void 0)},function(a){return d[96]=d[49].get("epoch_id"),d[97]=new c.Map(),d[97].set("supported_encryption_versions",d[86]),d[97].set("client_version",c.i64.cast([0,1])),d[97].set("version_sig",d[95]==null?"":d[95]),d[98]=d[42].get("device_public_key"),d[99]=d[42].get("device_private_key"),c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,2]))?c.resolve(d[100]=void 0):c.sequence([function(a){return c.nativeOperation(b("LSGetArmadilloPublicKey.nop")).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[100]=d[107]}])},function(a){return c.blobs.neq(d[100],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSCreateSignatureWithArmadilloKey.nop"),d[98]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return c.blobs.neq(d[107],void 0)?c.resolve(d[108]=d[107]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),d[113]="Failed to create labyrinth signature",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",d[113]].join("")),d[112]=c.createArray(),void 0!==void 0?d[114]=(d[112].push(void 0),d[112]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",d[113],d[112],c.i64.cast([0,3]))},function(a){return d[108]=void 0}])},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[99],c.blob("Mw=="),d[100]).then(function(a){return a=a,d[109]=a[0],a})},function(a){return c.blobs.neq(d[109],void 0)?c.resolve(d[110]=d[109]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),d[113]="Failed to create armadillo signature",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",d[113]].join("")),d[112]=c.createArray(),void 0!==void 0?d[114]=(d[112].push(void 0),d[112]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",d[113],d[112],c.i64.cast([0,3]))},function(a){return d[110]=void 0}])},function(a){return c.blobs.neq(d[110],void 0)?(c.blobs.neq(d[108],void 0)?(d[113]=new c.Map(),d[113].set("armadillo_public_key",d[100]),d[113].set("armadillo_key_signature",d[110]),d[113].set("labyrinth_key_signature",d[108]),d[112]=d[113]):d[112]=void 0,d[111]=d[112]):d[111]=void 0,d[101]=d[111]}]):c.resolve(d[101]=void 0)},function(a){return d[101]!==void 0?c.sequence([function(a){return d[107]=d[101].get("armadillo_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[107]).then(function(a){return a=a,d[108]=a[0],a})},function(a){return d[109]=d[101].get("armadillo_key_signature"),c.nativeOperation(b("LSBase64Encode.nop"),d[109]).then(function(a){return a=a,d[110]=a[0],a})},function(a){return d[111]=d[101].get("labyrinth_key_signature"),c.nativeOperation(b("LSBase64Encode.nop"),d[111]).then(function(a){return a=a,d[112]=a[0],a})},function(a){return d[113]=new c.Map(),d[113].set("armadillo_public_key",d[108]==null?"":d[108]),d[113].set("armadillo_key_signature",d[110]==null?"":d[110]),d[113].set("labyrinth_key_signature",d[112]==null?"":d[112]),d[102]=d[113]}]):c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure] Failed to get armadillo key and device signatures"),d[102]=void 0))},function(e){return d[103]=new c.Map(),d[103].set("backup_id",d[14]),d[103].set("device_public_key",d[52]==null?"":d[52]),d[103].set("epoch_storage_pubkey",d[59]==null?"":d[59]),d[103].set("epoch_storage_pubkey_sig",d[61]==null?"":d[61]),d[103].set("epoch_auth_pubkey",d[63]==null?"":d[63]),d[103].set("epoch_auth_pubkey_sig",d[65]==null?"":d[65]),d[103].set("ocmf_provider_device_id",a[0]),d[103].set("ocmf_rotation_token",d[67]==null?"":d[67]),d[103].set("device_epoch_hmac",d[54]==null?"":d[54]),d[103].set("epoch_root_key_fingerprint",d[57]),d[103].set("device_registration_id",f.deviceRegistrationId),d[103].set("base_epoch_id",d[96]),d[103].set("encryption_version_data",d[97]),d[103].set("ocmf_client_state_debug_token",d[73]),d[103].set("private_key_debug_token",d[71]),d[103].set("epoch_storage_pvtkey_debug_token",d[75]),d[103].set("occam_only_eligible",!0),d[103].set("armadillo_key_data",d[102]),d[104]=new c.Map(),d[104].set("success",d[103]),d[105]=c.toJSON(d[104]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[105],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[106]=a[0],a})},function(a){return d[48]=void 0}]):c.sequence([function(a){return d[47]!==void 0?c.sequence([function(a){return d[50]=d[47].get("error_message"),d[51]=d[47].get("error_code"),d[52]=new c.Map(),d[52].set("error_code",d[51]),d[52].set("stored_procedure","onboardFromExistingDeviceRegister"),d[52].set("error_message",d[50]),d[53]=new c.Map(),d[53].set("failure",d[52]),d[54]=c.toJSON(d[53]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[54],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[55]=a[0],a})},function(a){return d[56]=new c.Map(),d[56].set("error_code",d[51]),d[56].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[56].set("error_message",""),d[49]=d[56]}]):c.sequence([function(a){return d[50]=new c.Map(),d[50].set("error_code",c.i64.cast([0,603])),d[50].set("stored_procedure","onboardFromExistingDeviceRegister"),d[50].set("error_message","Unknown error encountered"),d[51]=new c.Map(),d[51].set("failure",d[50]),d[52]=c.toJSON(d[51]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[52],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[54]=new c.Map(),d[54].set("error_code",c.i64.cast([0,603])),d[54].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[54].set("error_message",""),d[49]=d[54]}])},function(a){return d[48]=d[49]}])},function(a){return d[41]=d[48]}]):c.sequence([function(a){return d[40]!==void 0?c.sequence([function(a){return d[43]=d[40].get("error_message"),d[44]=d[40].get("error_code"),d[45]=new c.Map(),d[45].set("error_code",d[44]),d[45].set("stored_procedure","onboardFromExistingDeviceRegister"),d[45].set("error_message",d[43]),d[46]=new c.Map(),d[46].set("failure",d[45]),d[47]=c.toJSON(d[46]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[47],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[49]=new c.Map(),d[49].set("error_code",d[44]),d[49].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[49].set("error_message",""),d[42]=d[49]}]):c.sequence([function(a){return d[43]=new c.Map(),d[43].set("error_code",c.i64.cast([0,603])),d[43].set("stored_procedure","onboardFromExistingDeviceRegister"),d[43].set("error_message","Unknown error encountered"),d[44]=new c.Map(),d[44].set("failure",d[43]),d[45]=c.toJSON(d[44]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[45],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[47]=new c.Map(),d[47].set("error_code",c.i64.cast([0,603])),d[47].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[47].set("error_message",""),d[42]=d[47]}])},function(a){return d[41]=d[42]}])},function(a){return d[37]=d[41]}]))})},function(a){return d[32]=d[37]}]):c.sequence([function(a){return d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,24])),d[33].set("stored_procedure","onboardFromExistingDeviceRegister"),d[33].set("error_message","Client state table fetch error"),d[34]=new c.Map(),d[34].set("failure",d[33]),d[35]=c.toJSON(d[34]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[35],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[37]=new c.Map(),d[37].set("error_code",c.i64.cast([0,24])),d[37].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[37].set("error_message",""),d[32]=d[37]}])},function(a){return d[7]=d[32]}]):c.sequence([function(a){return d[14]=d[5].get("errors"),d[15]=d[5].get("errors"),d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,1])),d[16].set("stored_procedure","onboardFromExistingDeviceRegister"),d[16].set("error_message","Client state table fetch error"),d[17]=new c.Map(),d[17].set("failure",d[16]),d[18]=c.toJSON(d[17]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50037]),d[18],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,1])),d[20].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure"),d[20].set("error_message",""),d[7]=d[20]}])},function(a){return d[8]=c.i64.of_float(Date.now()),d[9]=c.i64.random(),d[11]="Finishing execution. Execution time: ",d[12]=c.i64.to_string(c.i64.sub(d[8],d[0])),d[13]=" ms",d[10]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][onboardFromExistingDeviceRegister] ",d[10],d[11],d[10],d[12],d[10],d[13]].join("")),c.i64.eq(c.i64.mod_(d[9],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[14]=",",d[15]=c.createArray(),void 0!==void 0?d[16]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"onboardFromExistingDeviceRegister",[d[11],d[14],d[12],d[14],d[13]].join(""),d[15],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[7]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsOnboardFromExistingDeviceRegisterStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","device_metadata","secure_encrypted_backups_epochs"];e.exports=a}),null);